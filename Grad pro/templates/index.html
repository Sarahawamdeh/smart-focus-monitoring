<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Focus Monitoring ‚Äî Yarmouk University</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
/* ======= GENERAL ======= */
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #f9f9f9;
    background-image: repeating-linear-gradient(
        45deg, #f9f9f9, #f9f9f9 10px,
        #f1f1f1 10px, #f1f1f1 20px
    );
    color: #222;
}

.wrap {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

/* ======= TOP BAR ======= */
.topbar {
    background: #006b38;
    color: white;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    font-size: 16px;
    font-weight: 600;
    border-bottom: 3px solid #004d28;
}

/* ======= MAIN LAYOUT ======= */
.main {
    flex: 1;
    display: flex;
    padding: 10px;
    gap: 10px;
}

.left-panel,
.right-panel {
    width: 22%;
    background: #f4f4f4;
    border-radius: 12px;
    padding: 12px;
    overflow-y: auto;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.left-panel h4, 
.right-panel h4 {
    color: #000301;
    margin-top: 0;
    margin-bottom: 5px;
    border-bottom: 2px solid #ddd;
    padding-bottom: 5px;
}

.center {
    flex: 1;
}

/* ======= CAMERA AREA ======= */
.camera-frame {
    width: 100%;
    height: 420px;
    background: #eaeaea;
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    border: 2px solid #006b38;
}

.neon-border {
    position: absolute;
    inset: 0;
    border: 3px solid #006b38;
    filter: drop-shadow(0 0 6px #006b38);
    pointer-events: none;
    transition: 0.3s;
}

.video-box {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.controls {
    margin-top: 10px;
    display: flex;
    justify-content: flex-start; 
    gap: 10px;
    flex-wrap: wrap; 
}

.btn {
    flex: 1;
    padding: 10px 0;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: 0.3s;
    font-size: 14px;
    background-color: #0b6623;
    color: white;
    text-align: center;
}

.btn:hover {
    background-color: #064817;
    transform: scale(1.05);
}

.btn.start, .btn.stop, .btn.view {
    background-color: #0b6623;
    color: white;
}

/* ======= SHOW DETAILS BUTTON ======= */
.show-details-btn {
    margin: 15px auto 0;
    display: none;
    padding: 8px 20px;
    background: linear-gradient(135deg, #007a3d, #004d28);
    color: #fff;
    font-weight: 600;
    font-size: 13px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
}

.show-details-btn:hover {
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #00914d, #006b38);
}

.show-details-btn:active {
    transform: translateY(0px) scale(0.97);
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

/* ======= STUDENT LIST ======= */
.student {
    padding: 6px;
    margin-bottom: 5px;
    background: #fff;
    border-radius: 5px;
    border: 1px solid #c9c9c9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
}

.student:hover {
    background: #dff0d8;
    transform: scale(1.01);
}

/* ======= SIDEBAR ======= */
.student-sidebar {
    position: absolute;
    right: 0;
    top: 0;
    width: 200px;
    height: 100%;
    background: rgba(255,255,255,0.95);
    padding: 15px;
    color: #333;
    border-left: 2px solid #006b38;
    display: none;
    box-shadow: -4px 0 8px rgba(0,0,0,0.1);
    transition: 0.3s;
}

.card {
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    font-size: 14px;
}

#liveCam {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}

#startMsg {
    color: #333;
}

/* ===== RANDOM QUESTION MODAL ===== */
#questionModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 1000;
    width: 300px;
    text-align: center;
}

#questionText {
    font-weight: 600;
    margin-bottom: 10px;
}
#courseName {
    font-weight: 700;   /* ÿ∫ÿßŸÖŸÇ ÿ¥ŸàŸäÿ© */
    font-size: 34px;    /* ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿßŸÑÿ≥ŸÉÿ¥ŸÜ */
    color: #000b06;     /* ŸÑŸàŸÜ ÿßŸÑÿ¨ÿßŸÖÿπÿ© */
}

#sectionName {
    font-weight: 600;   /* ÿ£ÿÆŸÅ ŸÖŸÜ ÿßŸÑŸÉŸàÿ±ÿ≥ */
    font-size: 22px;    /* ÿ£ÿµÿ∫ÿ± ŸÖŸÜ ÿßŸÑŸÉŸàÿ±ÿ≥ */
    color: rgb(0, 7, 4);     /* ÿ£ÿ∫ŸÖŸÇ ŸÇŸÑŸäŸÑŸãÿß */
}

</style>
</head>
<body>
<div class="wrap">

<header class="topbar">
    <div class="brand">Yarmouk University ‚Äî Smart Focus Monitoring</div>
    <div class="overall" id="overallText">OVERALL CLASS FOCUS: -- %</div>
    <div class="timer" id="sessionTimer">Session Timer: 00:00:00</div>
</header>

<main class="main">

<section class="left-panel">
    <h4>
        <span id="courseName">python</span><br>
        <span id="sectionName">Section 1</span>
    </h4>

    <h3>Individual Student Focus</h3>
    <div id="studentsList"></div>
</section>

<section class="center">

    <div class="camera-frame">
        <div class="neon-border"></div>

        <div class="video-box" id="videoBox">
            <img id="liveCam" src="">
            <p id="startMsg">üé• Click Start Monitoring to begin</p>
        </div>

        <div class="student-sidebar" id="studentSidebar"></div>
    </div>

    <div class="controls">
        <button class="btn stop" id="stopBtn">STOP AND SAVE</button>
        <button class="btn start" id="startBtn">START MONITORING</button>
        <button class="btn start" id="highlightBtn">RANDOM STUDENT</button>
        <button class="btn view" id="randomQuestionBtn">RANDOM QUESTION</button>
    </div>

    <button class="show-details-btn" onclick="window.location.href='last_p.html'">SHOW DETAILS</button>

</section>

<aside class="right-panel">
    <h4>Date: <span id="dateInfo">-- / -- / ----</span></h4>
    <h3>Aggregate Analytics</h3>

    <div class="card">
        <div style="font-weight:700;">Average Focus</div>
        <div style="font-size:24px;color:#006b38;" id="avgFocusText">--%</div>
        <div style="font-size:12px;color:#888;">Live Average</div>
    </div>

    <div class="card">
        <div style="font-weight:700;">Highest Focused Student</div>
        <div id="topStudent">--</div>
    </div>

    <div class="card">
        <div style="font-weight:700;">Lowest Focused Student</div>
        <div id="lowStudent">--</div>
    </div>
</aside>

</main>
</div>

<div id="questionModal">
    <p id="questionText"></p>
    <button id="closeQuestionBtn" class="btn view">CLOSE</button>
</div>

<script>
// --- VARIABLES ---
const studentsListEl    = document.getElementById('studentsList');
const liveCam           = document.getElementById('liveCam');
const startMsg          = document.getElementById('startMsg');
const overallText       = document.getElementById('overallText');
const avgFocusText      = document.getElementById('avgFocusText');
const topStudentEl      = document.getElementById('topStudent');
const lowStudentEl      = document.getElementById('lowStudent');
const highlightBtn      = document.getElementById('highlightBtn');
const randomQuestionBtn = document.getElementById('randomQuestionBtn');
const questionModal     = document.getElementById('questionModal');
const questionText      = document.getElementById('questionText');
const closeQuestionBtn  = document.getElementById('closeQuestionBtn');
const showDetailsBtn    = document.querySelector('.show-details-btn');
const dateInfoEl        = document.getElementById('dateInfo');

let fetchIntervalID = null;
let sessionSec = 0;
let sessionTimerID = null;
let monitoringStarted = false; 
let highlightedStudentId = null;

// --- BUILD STUDENTS LIST ---
const MAX_EXPECTED = 5;
for (let i = 0; i < MAX_EXPECTED; i++) {
    const div = document.createElement('div');
    div.className = 'student';
    div.id = `student-${i}`;
    div.innerHTML = `
        <span class="name">Student ${i + 1}</span>
        <span class="focus" id="student-${i}-focus">--%</span>
    `;
    div.onclick = () => {
        const sidebar = document.getElementById('studentSidebar');
        const focusText = document.getElementById(`student-${i}-focus`).innerText;
        sidebar.style.display = 'block';
        sidebar.innerHTML = `<h4>Student ${i + 1}</h4><p>Focus: ${focusText}</p>`;
    };
    studentsListEl.appendChild(div);
}

// --- START / STOP ---
document.getElementById('startBtn').addEventListener('click', startMonitoring);
document.getElementById('stopBtn').addEventListener('click', stopMonitoring);

// --- RANDOM STUDENT ---
highlightBtn.addEventListener('click', async () => {
    if (!monitoringStarted) {
        alert("‚ö† Please start monitoring first!");
        return;
    }
    try {
        const res = await fetch('/highlight_random');
        if (!res.ok) return;
        const payload = await res.json();
        highlightedStudentId = payload.selected;
    } catch (e) {
        console.error(e);
    }
});

// --- RANDOM QUESTION ---
const questions = [
    "What was the last topic we talked about in the lecture?",
    "What does 'cloud storage' mean?",
    "What is the capital of Jordan?",
    "What is the name of the course and its code?",
    "Define IP address.",
    "What does HTML stand for?",
    "Explain TCP vs UDP.",
    "What does URL stand for?",
    "What is a variable?"
];

randomQuestionBtn.addEventListener('click', () => {
    if (!monitoringStarted) {
        alert("‚ö† Please start monitoring first!");
        return;
    }
    const q = questions[Math.floor(Math.random() * questions.length)];
    questionText.innerText = q;
    questionModal.style.display = 'block';
});

closeQuestionBtn.addEventListener('click', () => {
    questionModal.style.display = 'none';
});

function stopMonitoring() {
    liveCam.src = '';
    liveCam.style.display = 'none';
    startMsg.style.display = 'block';

    if (fetchIntervalID) {
        clearInterval(fetchIntervalID);
        fetchIntervalID = null;
    }

    if (sessionTimerID) {
        clearInterval(sessionTimerID);
        sessionTimerID = null;
    }

    monitoringStarted = false;
    showDetailsBtn.style.display = 'block';
}

function startMonitoring() {
    liveCam.style.display = 'block';
    startMsg.style.display = 'none';
    liveCam.src = '/video_feed';

    if (fetchIntervalID) clearInterval(fetchIntervalID);
    fetchIntervalID = setInterval(fetchFocusData, 500);

    if (sessionTimerID) clearInterval(sessionTimerID);
    sessionSec = 0;
    document.getElementById("sessionTimer").innerText = "Session Timer: 00:00:00";

    sessionTimerID = setInterval(() => {
        sessionSec++;
        let h = String(Math.floor(sessionSec / 3600)).padStart(2, "0"),
            m = String(Math.floor((sessionSec % 3600) / 60)).padStart(2, "0"),
            s = String(sessionSec % 60).padStart(2, "0");

        document.getElementById("sessionTimer").innerText =
            `Session Timer: ${h}:${m}:${s}`;
    }, 1000);

    monitoringStarted = true;
    showDetailsBtn.style.display = 'none';
}

// --- FETCH FOCUS DATA ---
async function fetchFocusData() {
    try {
        const res = await fetch('/focus-data', { cache: "no-store" });
        if (!res.ok) return;
        const payload = await res.json();

        overallText.innerText = `OVERALL CLASS FOCUS: ${payload.overall}%`;
        avgFocusText.innerText = `${payload.overall}%`;

        for (let i = 0; i < MAX_EXPECTED; i++) {
            const el = document.getElementById(`student-${i}-focus`);
            if (el) el.innerText = '--%';
        }

        let top = { id: null, focus: -1 };
        let low = { id: null, focus: 101 };

        payload.students.forEach(s => {
            const el = document.getElementById(`student-${s.id}-focus`);
            if (el) el.innerText = `${s.focus}%`;
            if (s.focus > top.focus) top = { id: s.id, focus: s.focus };
            if (s.focus < low.focus) low = { id: s.id, focus: s.focus };
        });

        topStudentEl.innerText = top.id !== null ? `Student ${top.id + 1} (${top.focus}%)` : '--';
        lowStudentEl.innerText = low.id !== null ? `Student ${low.id + 1} (${low.focus}%)` : '--';

    } catch (e) {
        console.error("Error fetching focus-data:", e)
    }
}

// --- UPDATE DATE ---
function updateDateTime() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const formattedDate = now.toLocaleDateString('ar-JO', options);
    dateInfoEl.textContent = formattedDate;
}

// --- INIT ---
updateDateTime();
</script>
</body>
</html>
