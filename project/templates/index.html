<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Focus Monitoring â€” Yarmouk University</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
/* ======= GENERAL ======= */
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background-color: #f9f9f9;
    background-image: repeating-linear-gradient(45deg, #f9f9f9, #f9f9f9 10px, #f1f1f1 10px, #f1f1f1 20px);
    color: #222;
}
.wrap {
    display: flex;
    flex-direction: column;
    height: 100vh;
}
/* ======= TOP BAR ======= */
.topbar {
    background: #006b38;
    color: white;
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    font-size: 18px;
    font-weight: 600;
    border-bottom: 3px solid #004d28;
}
/* ======= MAIN LAYOUT ======= */
.main {
    flex: 1;
    display: flex;
    padding: 10px;
    gap: 10px;
}
.left-panel, .right-panel {
    width: 22%;
    background: #f4f4f4;
    border-radius: 12px;
    padding: 15px;
    overflow-y: auto;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.center {
    flex: 1;
}
/* ======= CAMERA AREA ======= */
.camera-frame {
    width: 100%;
    height: 420px;
    background: #eaeaea;
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    border: 2px solid #006b38;
}
.neon-border {
    position: absolute;
    inset: 0;
    border: 3px solid #006b38;
    filter: drop-shadow(0 0 6px #006b38);
    pointer-events: none;
    transition: 0.3s;
}
.video-box {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}
.controls {
    margin-top: 12px;
    display: flex;
    justify-content: space-between;
}
.btn {
    padding: 10px 15px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    width: 32%;
    border: none;
    transition: 0.3s;
}
.btn:hover { transform: scale(1.05); }
.btn.start { background: #27ae60; color: white; }
.btn.stop { background: #e74c3c; color: white; }
.btn.view { background: #1b263b; color: white; }
/* ======= STUDENT LIST ======= */
.student {
    padding: 8px;
    margin-bottom: 6px;
    background: #ffffff;
    border-radius: 6px;
    border: 1px solid #c9c9c9;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.student:hover { background: #dff0d8; transform: scale(1.01); }
/* ======= SIDEBAR ======= */
.student-sidebar {
    position: absolute;
    right: 0;
    top: 0;
    width: 200px;
    height: 100%;
    background: rgba(255,255,255,0.95);
    padding: 15px;
    color: #333;
    border-left: 2px solid #006b38;
    display: none;
    box-shadow: -4px 0 8px rgba(0,0,0,0.1);
    transition: 0.3s;
}
.card { background:#fff; padding:10px; border-radius:8px; margin-bottom:10px; box-shadow:0 3px 6px rgba(0,0,0,0.1); }

#liveCam { width:100%; height:100%; object-fit:cover; display:none; }
#startMsg { color:#333; }
</style>
</head>
<body>
<div class="wrap">
<header class="topbar">
    <div class="brand">Yarmouk University â€” Smart Focus Monitoring</div>
    <div class="overall" id="overallText">OVERALL CLASS FOCUS: -- %</div>
    <div class="timer" id="sessionTimer">Session Timer: 00:00:00</div>
</header>
<main class="main">
<section class="left-panel">
    <h3>Individual Student Focus</h3>
    <div id="studentsList"></div>
    <div class="chart-container">
        <canvas id="overallChart"></canvas>
    </div>
</section>

<section class="center">
    <div class="camera-frame">
        <div class="neon-border"></div>
        <div class="video-box" id="videoBox">
            <img id="liveCam" src="">
            <p id="startMsg">ğŸ¥ Click Start Monitoring to begin</p>
        </div>
        <div class="student-sidebar" id="studentSidebar"></div>
    </div>

    <div class="controls">
        <button class="btn stop" id="stopBtn">STOP MONITORING</button>
        <button class="btn view" id="viewBtn">VIEW HISTORICAL DATA</button>
        <button class="btn start" id="startBtn">START MONITORING</button>
    </div>
</section>

<aside class="right-panel">
    <h3>Aggregate Analytics</h3>
    <div class="card">
        <div style="font-weight:700;">Average Focus</div>
        <div style="font-size:24px;color:#006b38;" id="avgFocusText">--%</div>
    </div>
    <div class="card">
        <div style="font-weight:700;">Highest Focused Student</div>
        <div id="topStudent">--</div>
    </div>
    <div class="card">
        <div style="font-weight:700;">Lowest Focused Student</div>
        <div id="lowStudent">--</div>
    </div>
</aside>
</main>
</div>

<script>
// ----- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© -----
const studentsListEl = document.getElementById('studentsList');
const liveCam = document.getElementById('liveCam');
const startMsg = document.getElementById('startMsg');
const overallText = document.getElementById('overallText');
const avgFocusText = document.getElementById('avgFocusText');
const topStudentEl = document.getElementById('topStudent');
const lowStudentEl = document.getElementById('lowStudent');

let fetchIntervalID = null;
let sessionSec = 0;
let sessionTimerID = null;

// Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ø·Ù„Ø§Ø¨ (Ù„Ùˆ Ø¨Ø¯Ùƒ ØªØ³Ø­Ø¨ÙŠ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø¨Ø¹Ø¯ÙŠÙ†ØŒ ØºÙŠØ± Ø§Ù„Ø¬Ø²Ø¡ Ù‡Ø°Ø§)
const MAX_EXPECTED = 5; // Ù†ÙØ³ Ù‚ÙŠÙ…Ø© max_num_faces ÙÙŠ Flask
for (let i=0;i<MAX_EXPECTED;i++){
    const div = document.createElement('div');
    div.className = 'student';
    div.id = `student-${i}`;
    div.innerHTML = `<span class="name">Student ${i+1}</span><span class="focus" id="student-${i}-focus">--%</span>`;
    div.onclick = ()=> {
        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø¬Ø§Ù†Ø¨ÙŠ
        const sidebar = document.getElementById('studentSidebar');
        const focusText = document.getElementById(`student-${i}-focus`).innerText;
        sidebar.style.display = 'block';
        sidebar.innerHTML = `<h4>Student ${i+1}</h4><p>Focus: ${focusText}</p>`;
    }
    studentsListEl.appendChild(div);
}

// Start / Stop handlers
document.getElementById('startBtn').addEventListener('click', ()=> {
    startMonitoring();
});
document.getElementById('stopBtn').addEventListener('click', ()=> {
    stopMonitoring();
});

function startMonitoring(){
    liveCam.style.display = 'block';
    startMsg.style.display = 'none';
    liveCam.src = '/video_feed';

    // Ø§Ø¨Ø¯Ø£ fetch Ù„Ù„Ù€ focus-data ÙƒÙ„ 500ms
    if (fetchIntervalID) clearInterval(fetchIntervalID);
    fetchIntervalID = setInterval(fetchFocusData, 500);

    // reset timer
    if (sessionTimerID) clearInterval(sessionTimerID);
    sessionSec = 0;
    sessionTimerID = setInterval(()=> {
        sessionSec++;
        let h=String(Math.floor(sessionSec/3600)).padStart(2,"0"),
            m=String(Math.floor((sessionSec%3600)/60)).padStart(2,"0"),
            s=String(sessionSec%60).padStart(2,"0");
        document.getElementById("sessionTimer").innerText=`Session Timer: ${h}:${m}:${s}`;
    },1000);
}

function stopMonitoring(){
    liveCam.src = '';
    liveCam.style.display = 'none';
    startMsg.style.display = 'block';

    if (fetchIntervalID) {
        clearInterval(fetchIntervalID);
        fetchIntervalID = null;
    }
    if (sessionTimerID) {
        clearInterval(sessionTimerID);
        sessionTimerID = null;
    }
}

// Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
async function fetchFocusData(){
    try {
        const res = await fetch('/focus-data', {cache: "no-store"});
        if (!res.ok) return;
        const payload = await res.json();
        // payload: { students: [{id: <fid>, focus: <num>}, ...], overall: <num> }
        // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ
        overallText.innerText = `OVERALL CLASS FOCUS: ${payload.overall}%`;
        avgFocusText.innerText = `${payload.overall}%`;

        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø·Ø§Ù„Ø¨
        // Ù†Ø­Ø§ÙˆÙ„ ØªØµÙÙŠØ± Ø§Ù„Ù‚ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ù„Ù‰ --% Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠÙƒØªØ´ÙÙˆØ§ Ø¨Ø¹Ø¯
        for (let i=0;i<MAX_EXPECTED;i++){
            const el = document.getElementById(`student-${i}-focus`);
            if (el) el.innerText = `--%`;
        }

        let top = {id:null, focus:-1}, low = {id:null, focus:101};
        payload.students.forEach(s=>{
            const el = document.getElementById(`student-${s.id}-focus`);
            if (el) el.innerText = `${s.focus}%`;
            if (s.focus > top.focus) top = {id: s.id, focus: s.focus};
            if (s.focus < low.focus) low = {id: s.id, focus: s.focus};
        });

        if (top.id !== null) topStudentEl.innerText = `Student ${top.id+1} (${top.focus}%)`;
        else topStudentEl.innerText = '--';

        if (low.id !== null) lowStudentEl.innerText = `Student ${low.id+1} (${low.focus}%)`;
        else lowStudentEl.innerText = '--';
    } catch (e) {
        console.error("Error fetching focus-data:", e);
    }
}

// Ø±Ø³Ù… Ø®Ø· Ø¨Ø³ÙŠØ· ÙŠØ­Ø¯Ù‘Ø« Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ (ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù€ overall history Ø¥Ù† Ø£Ø±Ø¯Øª)
const ctx=document.getElementById("overallChart");
let chartData=[60,63,58,70,75];
let chartLabels=["0","1","2","3","4"];
const chart=new Chart(ctx,{
    type:"line",
    data:{
        labels:chartLabels,
        datasets:[{
            label:"Overall Focus",
            data:chartData,
            borderWidth:2,
            borderColor:"#006b38",
            tension:0.3
        }]
    },
});
setInterval(()=>{
    // ÙÙ‚Ø· Ù„Ù…Ø¸Ù‡Ø± Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØŒ Ù„Ø§ ÙŠÙ„ØºÙŠ fetch Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    const nextValue = Math.floor(Math.random()*41+60);
    chart.data.labels.push(chart.data.labels.length);
    chart.data.datasets[0].data.push(nextValue);
    if(chart.data.labels.length>10){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update();
},5000);
</script>
</body>
</html>
